<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inyector de Eventos - omniGuard</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
      margin: 0; 
      padding: 24px; 
      line-height: 1.6; 
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      min-height: 100vh;
      color: #333;
    }
    .container { 
      max-width: 1200px; 
      margin: 0 auto; 
      background: rgba(255, 255, 255, 0.95); 
      border-radius: 16px; 
      padding: 32px; 
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }
    h2 { 
      margin: 0 0 32px 0; 
      font-size: 2.5rem; 
      font-weight: 700; 
      background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
      -webkit-background-clip: text; 
      -webkit-text-fill-color: transparent; 
      text-align: center;
    }
    .row { display: flex; gap: 16px; flex-wrap: wrap; }
    label { 
      display: block; 
      font-weight: 600; 
      margin: 16px 0 8px 0; 
      color: #374151; 
      font-size: 14px;
    }
    input, textarea, select { 
      width: 100%; 
      padding: 12px 16px; 
      font-size: 14px; 
      border: 2px solid #e5e7eb; 
      border-radius: 8px; 
      transition: all 0.2s ease;
      background: #fff;
    }
    input:focus, textarea:focus, select:focus { 
      outline: none; 
      border-color: #3b82f6; 
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); 
    }
    button { 
      padding: 12px 20px; 
      font-size: 14px; 
      font-weight: 600; 
      cursor: pointer; 
      border: none; 
      border-radius: 8px; 
      transition: all 0.2s ease;
      background: linear-gradient(135deg, #3b82f6, #1d4ed8);
      color: white;
      margin: 4px;
    }
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3); 
    }
    button:active { transform: translateY(0); }
    .muted { 
      color: #6b7280; 
      font-size: 12px; 
      margin-top: 8px; 
      line-height: 1.4;
    }
    .log { 
      background: #1a1a1a; 
      color: #e6edf3; 
      padding: 20px; 
      border-radius: 12px; 
      white-space: pre-wrap; 
      max-height: 400px; 
      overflow-y: auto; 
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 13px;
      border: 1px solid #333;
    }
    .ok { color: #22c55e; }
    .err { color: #ef4444; }
    .card { 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      padding: 24px; 
      margin-bottom: 24px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
      transition: box-shadow 0.2s ease;
    }
    .card:hover { box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .card h3 { 
      margin: 0 0 20px 0; 
      font-size: 1.25rem; 
      font-weight: 600; 
      color: #374151;
    }
    .button-group { 
      display: flex; 
      gap: 8px; 
      flex-wrap: wrap; 
      margin-top: 16px; 
    }
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-online { background: #22c55e; }
    .status-offline { background: #ef4444; }
    .grid-2 { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 16px; 
    }
    @media (max-width: 768px) {
      .container { margin: 16px; padding: 20px; }
      .grid-2 { grid-template-columns: 1fr; }
      h2 { font-size: 2rem; }
    }
  </style>
  <script>
    async function postEvent(baseUrl, payload) {
      const url = baseUrl.replace(/\/$/, '') + '/event';
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const text = await res.text();
      let body = text;
      try { body = JSON.parse(text); } catch {}
      return { status: res.status, ok: res.ok, body };
    }

    function nowIso() {
      return new Date().toISOString().replace(/\.\d{3}Z$/, 'Z');
    }

    function randBetween(min, max) {
      return Math.random() * (max - min) + min;
    }

    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function genRandomEvent() {
      const sources = ['cam_entrada', 'cam_patios', 'cam_bodega', 'cam_estacionamiento'];
      const descriptions = [
        'Persona detectada cerca de la puerta',
        'Vehículo acercándose a zona restringida',
        'Movimiento inusual en bodega',
        'Posible objeto sospechoso',
      ];
      return {
        source: pick(sources),
        description: pick(descriptions),
        value: Math.round(randBetween(0.1, 0.99) * 100) / 100,
        timestamp: nowIso(),
      };
    }

    function readFormEvent() {
      const source = document.getElementById('source').value.trim();
      const description = document.getElementById('description').value.trim();
      const valueStr = document.getElementById('value').value.trim();
      const ts = document.getElementById('timestamp').value.trim();
      const value = valueStr === '' ? null : Number(valueStr);
      const payload = { source, description };
      if (!source || !description) throw new Error('source y description son obligatorios');
      if (!Number.isNaN(value) && value !== null) payload.value = value;
      if (ts) payload.timestamp = ts;
      return payload;
    }

    let successCount = 0;
    let errorCount = 0;

    function log(line, type) {
      const el = document.getElementById('log');
      const span = document.createElement('div');
      if (type === 'ok') {
        span.className = 'ok';
        successCount++;
      }
      if (type === 'err') {
        span.className = 'err';
        errorCount++;
      }
      span.textContent = line;
      el.prepend(span);
      
      // Mostrar mensaje de éxito si hay eventos exitosos y no hay errores
      const successMsg = document.getElementById('successMessage');
      if (successCount > 0 && errorCount === 0) {
        successMsg.style.display = 'block';
        successMsg.innerHTML = `✅ ¡${successCount} evento(s) inyectado(s) exitosamente!`;
      } else if (errorCount > 0) {
        successMsg.style.display = 'none';
      }
    }

    async function sendOne(ev) {
      const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://localhost:8001';
      try {
        const payload = ev === 'random' ? genRandomEvent() : readFormEvent();
        const { ok, status, body } = await postEvent(baseUrl, payload);
        if (ok) log(`✔ (${status}) ${JSON.stringify(payload)} => ${JSON.stringify(body)}`, 'ok');
        else log(`✖ (${status}) ${JSON.stringify(payload)} => ${typeof body === 'string' ? body : JSON.stringify(body)}`, 'err');
      } catch (e) {
        log(`✖ Error: ${e}`, 'err');
      }
    }

    async function sendBurst() {
      const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://localhost:8001';
      const count = Number(document.getElementById('burstCount').value) || 5;
      for (let i = 0; i < count; i++) {
        const payload = genRandomEvent();
        try {
          const { ok, status, body } = await postEvent(baseUrl, payload);
          if (ok) log(`✔ (${status}) ${JSON.stringify(payload)} => ${JSON.stringify(body)}`, 'ok');
          else log(`✖ (${status}) ${JSON.stringify(payload)} => ${typeof body === 'string' ? body : JSON.stringify(body)}`, 'err');
        } catch (e) {
          log(`✖ Error: ${e}`, 'err');
        }
        await new Promise(r => setTimeout(r, 150));
      }
    }

    async function checkServerStatus() {
      const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://localhost:8001';
      const statusEl = document.getElementById('serverStatus');
      const indicator = statusEl.querySelector('.status-indicator');
      const text = statusEl.querySelector('span:last-child');
      
      try {
        const url = baseUrl.replace(/\/$/, '') + '/health';
        const res = await fetch(url, { method: 'GET', timeout: 5000 });
        if (res.ok) {
          indicator.className = 'status-indicator status-online';
          text.textContent = 'Conectado';
          log(`🔍 Servidor verificado: ${baseUrl}`, 'ok');
        } else {
          indicator.className = 'status-indicator status-offline';
          text.textContent = `Error ${res.status}`;
          log(`🔍 Servidor respondió con error: ${res.status}`, 'err');
        }
      } catch (e) {
        indicator.className = 'status-indicator status-offline';
        text.textContent = 'Desconectado';
        log(`🔍 Error verificando servidor: ${e.message}`, 'err');
      }
    }

    async function reviewAllLogs() {
      const baseUrl = document.getElementById('baseUrl').value.trim() || 'http://localhost:8001';
      try {
        const url = baseUrl.replace(/\/$/, '') + '/events';
        const res = await fetch(url, { method: 'GET' });
        if (res.ok) {
          const data = await res.json();
          const events = data.items || [];
          log(`📊 Revisión de logs: ${events.length} eventos encontrados`, 'ok');
          
          if (events.length > 0) {
            // Mostrar los últimos 10 eventos
            const recentEvents = events.slice(-10);
            recentEvents.forEach((event, index) => {
              const timestamp = event.timestamp || 'Sin timestamp';
              const source = event.source || 'Sin fuente';
              const description = event.description || 'Sin descripción';
              const value = event.value !== undefined ? event.value : 'N/A';
              log(`  ${events.length - 10 + index + 1}. [${timestamp}] ${source}: ${description} (valor=${value})`, 'ok');
            });
            
            if (events.length > 10) {
              log(`  ... y ${events.length - 10} eventos más`, 'ok');
            }
          } else {
            log('  No hay eventos en el log', 'ok');
          }
        } else {
          log(`✖ Error obteniendo logs: ${res.status}`, 'err');
        }
      } catch (e) {
        log(`✖ Error revisando logs: ${e.message}`, 'err');
      }
    }

    function clearLog() {
      document.getElementById('log').innerHTML = 'Log limpiado...';
      document.getElementById('successMessage').style.display = 'none';
      successCount = 0;
      errorCount = 0;
    }

    // Verificar estado del servidor al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(checkServerStatus, 1000);
    });
  </script>
</head>
<body>
  <div class="container">
    <h2>🚀 Inyector de Eventos omniGuard</h2>
    
    <div class="card">
      <h3>🔗 Configuración del Servidor</h3>
      <label>URL del servidor</label>
      <input id="baseUrl" placeholder="http://localhost:8001" value="http://localhost:8001">
      <div class="muted">El endpoint usado es <code>/event</code>. Asegúrate de que el servidor esté corriendo y CORS habilitado.</div>
    </div>

    <div class="card">
      <h3>📝 Enviar Evento Manual</h3>
      <label>Source (Fuente)</label>
      <input id="source" placeholder="cam_entrada">
      <label>Description (Descripción)</label>
      <input id="description" placeholder="Persona detectada">
      <div class="grid-2">
        <div>
          <label>Value (Valor - opcional)</label>
          <input id="value" type="number" step="0.01" placeholder="0.85">
        </div>
        <div>
          <label>Timestamp (ISO8601 - opcional)</label>
          <input id="timestamp" placeholder="2025-10-01T12:00:00Z">
        </div>
      </div>
      <div class="button-group">
        <button onclick="sendOne('manual')">📤 Enviar</button>
        <button onclick="(document.getElementById('timestamp').value = new Date().toISOString().replace(/\.\d{3}Z$/, 'Z'))">⏰ Ahora</button>
        <button onclick="document.getElementById('source').value='cam_entrada'; document.getElementById('description').value='Persona detectada'; document.getElementById('value').value='0.9';">🎯 Ejemplo</button>
      </div>
    </div>

    <div class="card">
      <h3>🎲 Enviar Eventos Aleatorios</h3>
      <div class="grid-2">
        <div>
          <label>Cantidad de eventos</label>
          <input id="burstCount" type="number" value="1" min="1" max="100">
        </div>
        <div>
          <label>Estado del servidor</label>
          <div id="serverStatus" style="display: flex; align-items: center; margin-top: 8px;">
            <span class="status-indicator status-offline"></span>
            <span>Desconocido</span>
          </div>
        </div>
      </div>
      <div class="button-group">
        <button onclick="sendOne('random')">🎲 Enviar 1 Aleatorio</button>
        <button onclick="sendBurst()">🚀 Enviar Ráfaga</button>
        <button onclick="checkServerStatus()">🔍 Verificar Servidor</button>
      </div>
    </div>

    <div class="card">
      <h3>📋 Log de Actividad</h3>
      <div id="successMessage" style="display: none; background: #dcfce7; color: #166534; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid #22c55e;">
        ✅ ¡Eventos inyectados exitosamente!
      </div>
      <div id="log" class="log">Esperando eventos...</div>
      <div class="button-group">
        <button onclick="reviewAllLogs()">📊 Revisar Todos los Logs</button>
        <button onclick="clearLog()">🗑️ Limpiar Log</button>
      </div>
    </div>
  </div>
</body>
</html>



